!function(i){var e={key_box_id:"woocommerce_amazon_payments_advanced_keys_json",are_keys_set:amazon_admin_params.keys_already_set,init:function(){this.are_keys_set&&e.hide_key_box(),i("label[for="+this.key_box_id+"]").click(function(){e.show_key_box()})},hide_key_box:function(){i("#"+this.key_box_id).hide()},show_key_box:function(){i("#"+this.key_box_id).show()}};e.init();var a={simple_path_form_id:"simple_path",payment_region_input:i("#woocommerce_amazon_payments_advanced_payment_region"),json_key_input:i("#woocommerce_amazon_payments_advanced_keys_json"),action_url:"#",spId:"",register_now_link:i("a.register_now"),locale:amazon_admin_params.locale,home_url:amazon_admin_params.home_url,merchant_unique_id:amazon_admin_params.merchant_unique_id,public_key:amazon_admin_params.public_key,exchange_url:amazon_admin_params.simple_path_url,privacy_url:amazon_admin_params.privacy_url,site_description:amazon_admin_params.description,login_redirect_url:amazon_admin_params.login_redirect_url,poll_timer:!1,poll_interval:3e3,init:function(){a.payment_region_on_change(),a.create_form(),a.payment_region_input.on("change",this.payment_region_on_change),a.json_key_input.on("change",this.json_key_on_change),a.register_now_link.on("click",this.register_link_on_click)},payment_region_on_change:function(){"jp"===a.get_region_selected()?(a.register_now_link.attr("href",a.get_simple_path_url()),a.register_now_link.attr("target","_blank")):(a.register_now_link.attr("href","#"),a.register_now_link.removeAttr("target"),a.action_url=a.get_simple_path_url(),a.spId=a.get_spId(),i("#"+a.simple_path_form_id).attr("action",a.action_url),i("input[name=spId]").val(a.spId))},json_key_on_change:function(){try{var e=i.parseJSON(i(this).val());if(a.json_key_input.removeClass("json_key_error"),e.encryptedKey)return a.poll_timer=!1,a.json_encrypted_on_change(e);a.set_credentials_values(e.merchant_id,e.access_key,e.secret_key,e.client_id,e.client_secret),a.json_key_input.addClass("json_key_valid")}catch(e){a.json_key_input.removeClass("json_key_valid"),a.json_key_input.addClass("json_key_error")}},json_encrypted_on_change:function(e){i.ajax({url:amazon_admin_params.ajax_url,data:{action:"amazon_manual_exchange",nonce:amazon_admin_params.manual_exchange_nonce,data:e,region:a.payment_region_input.val()},type:"POST",success:function(e){try{var n=i.parseJSON(e.data);a.set_credentials_values(n.merchant_id,n.access_key,n.secret_key,n.client_id,n.client_secret),a.json_key_input.val(e.data),a.json_key_input.removeClass("json_key_error"),a.json_key_input.addClass("json_key_valid")}catch(e){a.json_key_input.removeClass("json_key_valid"),a.json_key_input.addClass("json_key_error"),a.poll_timer=!0,a.poll_for_keys()}},error:function(){a.json_key_input.removeClass("json_key_valid"),a.json_key_input.addClass("json_key_error"),a.poll_timer=!0,a.poll_for_keys()}})},set_credentials_values:function(e,n,a,_,t){i("#woocommerce_amazon_payments_advanced_seller_id").val(e),i("#woocommerce_amazon_payments_advanced_mws_access_key").val(n),i("#woocommerce_amazon_payments_advanced_secret_key").val(a),i("#woocommerce_amazon_payments_advanced_app_client_id").val(_),i("#woocommerce_amazon_payments_advanced_app_client_secret").val(t)},register_link_on_click:function(){"jp"!==a.get_region_selected()&&(document.getElementById(a.simple_path_form_id).submit.click(),a.poll_timer=setTimeout(a.poll_for_keys,a.poll_interval)),i("#woocommerce_amazon_payments_advanced_redirect_authentication").val("optimal")},create_form:function(){i(".wrap.woocommerce").append(i("<form/>",{id:a.simple_path_form_id,action:a.action_url,method:"post",target:"_blank"}).append(i("<input/>",{type:"hidden",name:"spId",value:a.spId}),i("<input/>",{type:"hidden",name:"publicKey",value:a.public_key}),i("<input/>",{type:"hidden",name:"keyShareURL",value:a.exchange_url}),i("<input/>",{type:"hidden",name:"locale",value:a.locale}),i("<input/>",{type:"hidden",name:"merchantLoginDomains[]",value:a.home_url}),i("<input/>",{type:"hidden",name:"merchantLoginRedirectURLs[]",value:a.exchange_url}),i("<input/>",{type:"hidden",name:"merchantLoginRedirectURLs[]",value:a.login_redirect_url}),i("<input/>",{type:"hidden",name:"merchantPrivacyNoticeURL",value:a.privacy_url}),i("<input/>",{type:"hidden",name:"merchantStoreDescription",value:a.site_description}),i("<input/>",{type:"hidden",name:"source",value:"SPPL"}),i("<input/>",{type:"submit",name:"submit",style:"display:none",value:"submit"})))},get_region_selected:function(){return a.payment_region_input.val()},get_simple_path_url:function(){return amazon_admin_params.simple_path_urls[a.get_region_selected()]},get_spId:function(){return amazon_admin_params.spids[a.get_region_selected()]},poll_for_keys:function(){clearTimeout(a.poll_timer),i.ajax({url:amazon_admin_params.ajax_url,data:{action:"amazon_check_credentials",nonce:amazon_admin_params.credentials_nonce},type:"GET",success:function(e){if("1"===e)location.reload();else{if(!1===a.poll_timer)return;a.poll_timer=setTimeout(a.poll_for_keys,a.poll_interval)}}})}};a.init()}(jQuery);
